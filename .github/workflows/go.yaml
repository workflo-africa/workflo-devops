name: Go Deploy

on:
  workflow_call:
    inputs:
      version:
        required: false
        type: string
      service:
        required: true
        type: string
      service-port:
        required: false
        type: number
      deploy-host-ip:
        required: true
        type: string
      deploy-host-port:
        required: true
        type: number
      deploy-dir:
        required: true
        type: string
      go-version:
        required: false
        type: string
      go-file:
        type: string
        default: ./main.go
    secrets:
      git-token:
        required: true
      git-user:
        required: true
      deploy-ssh-private-key:
        required: true
      docker-token:
        required: true
      docker-user:
        required: true
jobs:
  build:
    uses: Instacomm/devops/.github/workflows/go-build.yaml@v1
    with:
      service: ${{ inputs.service }}
      version: ${{ inputs.version }}
      service-port: ${{ inputs.service-port || 80 }}
      go-version: ${{ inputs.go-version || '1.25' }}
    secrets:
      git-token: ${{ secrets.git-token }}
      git-user: ${{ secrets.git-user }}
      docker-token: ${{ secrets.docker-token }}
      docker-user: ${{ secrets.docker-user }}
    permissions:
      id-token: write
      contents: read
  deploy:
    needs: build
    uses: Instacomm/devops/.github/workflows/vps-docker-deploy.yaml@v1
    with:
      service: ${{ inputs.service }}
      deploy-host: "${{ inputs.service }}.instacom"
      deploy-host-ip: ${{ inputs.deploy-host-ip }}
      deploy-host-port: ${{ inputs.deploy-host-port }}
      deploy-dir: ${{ inputs.deploy-dir }}
      tag: ${{ inputs.version || github.sha }}
    secrets:
      deploy-ssh-private-key: ${{ secrets.deploy-ssh-private-key }}
    permissions:
      id-token: write
      contents: read
